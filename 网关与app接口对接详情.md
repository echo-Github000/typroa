### 网关与app接口对接详情(本地场景所涉及)

#### 一. JNI对接接口：

相应接口的细则请参见：xxx，本文主要介绍对接接口的需求背景，用途以及调用场景。

**屏端->网关**

1. **fetch_local_scenes_reply：**

   **背景：**网关场景执行的本地化实施方案要求网关应保存与云端一致的本地场景列表，故网关应有向云端获取场景列表的方法，但网关作为Android应用的动态库，网关需要使用JNI接口的native方法通过Android应用与云端进行信息的交互，故有此方法。

   **用途：**该方法为网关通过接口ext_android_gw_fetch_local_scenes_cb主动向云端请求场景列表的回复，主要用于网关同步云端的最新本地场景列表。

   **调用场景：**1. 网关定时或者网关网络有变化时主动向云端获取最新的场景列表；2. 云端场景列表有变更时，主动通知网关有场景变化的事件，网关再主动取拉取全量的场景列表。

2. **device_change_notify：**

   **背景：**homepad plus自身的按键可作为本地场景的触发条件，但因plus的按键属性属于homepad范畴，故其属性变化或事件发生需通知到网关才可触发本地场景，故有此native方法。

   **用途：**该方法是将homepad plus自身按键属性变化或事件发生下发到网关，网关判断是否满足本地场景的触发条件。

   **调用场景：**

   ​	作为有线开关的情况：1. 用户主动点击开关触发的属性变化；2. app上点击开关触发的属性变化；3. 开关作为场景的then，当场景执行时触发的属性变化；4. 网关开机时或重新绑定时的全量初始属性上报

   ​	作为场景开关的情况（本地策略下或离线状态下）：1.用户主动点击触发的事件发生；2. app上点击触发的事件发生；3. 网关开机时或重新绑定后的全量初始属性上报（云端策略下，场景开关的触发会直接调用云端的接口触发场景）。

3. **do_local_scene：**

   **背景：**homepad屏端支持场景卡片的功能需求，本地策略或离线状态下点击相应卡片即可执行同网关的本地场景（暂不支持局域网场景），homepad桌面创建场景卡片时，便会从云端拉取相应的场景信息，包含场景id等，本地策略或离线情况点击卡片，pad端调用此接口将要执行的场景id下发到网关，网关去执行相应的场景。

   **用途：**该方法为本地策略或离线状态下，点击场景卡片时调用该方法下发场景id，网关代为执行场景，仅限同网关场景。

   **调用场景：**1.本地策略或离线状态下点击场景卡片。

4. **get_lan_scene_executor：**

   **背景：**场景的执行策略由云端通过Android侧的MQTT直接透传到网关设备，homepad本身不知道具体的策略，而homepad自身按键的属性变更或事件发生是否发送到网关也需依据该策略，同时无论是上报到云端的消息或是下发到网关的消息都应携带该策略字段，所以需要一个接口从网关侧获取执行策略。

   **用途：**该方法用于homepad端向网关获取场景执行策略。

   **调用场景：**1. pad自身按键属性变化或事件发生后，上报云端以及下发到网关相应消息时。

**网关->屏端**

1. **ext_android_gw_fetch_local_scenes_cb：**

   **背景：**同fetch_local_scenes_reply方法。

   **用途：**该方法用于网关主动向云端请求场景列表。

   **调用场景：**1. 网关定时或者网关网络有变化时主动向云端获取最新的场景列表；2. 云端场景列表有变更时，主动通知网关有场景变化的事件，网关再自动取拉取全量的场景列表。

2. **ext_android_gw_device_cmd_cb：**

   **背景：**由于homepad的开关等可以作为本地场景的then，在网关触发到相应场景时，就需要判断该动作或属性是否属于homepad自身，如果是就需要通过该接口将动作或属性设置的消息传递给homepad，homepad侧做响应。

   **用途：**该方法用于网关向homepad自身发送属性设置或动作执行消息。

   **调用场景：**1.场景执行的then涉及homepad自身属性或动作时。

3. **ext_android_gw_local_scenes_log_cb：**

   **背景：**由于homepad屏端需要知道本地场景的执行信息，包括场景名、场景执行成功与否等，用来将相应场景的执行结果展示到屏幕，故需此接口获取场景执行的日志。

   **用途：**该方法用于网关主动上传场景的执行日志到homepad。

   **调用场景：**1.执行本地场景时。

#### 二. MQTT对接方法：

**屏端->网关**

1. **"mesh.scene.update":**

   **用途：**该消息用于云端同网关本地场景列表变化时提醒网关更新。

2. **"mesh.lan.scene.update":**

   **用途：**该消息用于云端多网关本地场景列表变化时提醒网关更新。

3. **"gateway.master.selected":**

   **用途：**该消息用于云端主动下发场景控制器信息。

4. **"gateway.master.info.get":**

   **用途：**该消息用于云端回复网关主动获取场景控制器的请求。

**网关->屏端**

1. **"gateway.master.info.get"：**

   **用途：**该消息用于网关主动获取场景控制器信息。

